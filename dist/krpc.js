"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var net = require("net");
var dgram = require("dgram");
var bencode = require("./bencode");
var events_1 = require("events");
var KBucket = require("k-bucket");
var crypto_1 = require("crypto");
var Protocol = require("bittorrent-protocol");
var ut_metadata = require("ut_metadata");
var KRPC = (function (_super) {
    __extends(KRPC, _super);
    function KRPC() {
        var _this = _super.call(this) || this;
        _this.concurrency = 100;
        _this._running = new Map();
        _this._pending = new Array();
        _this._tick = 0;
        _this._socket = dgram.createSocket('udp4');
        _this._socket.on('message', function (data, rinfo) {
            var message = bencode.decode(data), type = message.y.toString();
            if (type == 'r' || type == 'e') {
                try {
                    var tid = message.t.readUInt16BE(0), query = _this._running.get(tid);
                    if (query)
                        query.response(message[type], rinfo);
                }
                catch (error) {
                }
            }
            else if (type == 'q') {
                try {
                    var tid = message.t.readUInt16BE(0), query = {
                        method: message.q.toString(),
                        data: message.a,
                        peer: { host: rinfo.address, port: rinfo.port },
                        response: _this._response(message, rinfo)
                    };
                    _this.emit('query', query);
                }
                catch (error) {
                }
            }
        });
        return _this;
    }
    KRPC.prototype._response = function (message, rinfo) {
        var _this = this;
        var _message = message;
        return function (data) {
            Promise.resolve(data).then(function (data) {
                var message = {
                    t: _message.t,
                    y: 'r',
                    r: data
                };
                _this._socket.send(bencode.encode(message), rinfo.port, rinfo.address);
            });
        };
    };
    KRPC.prototype._runQueries = function () {
        var _this = this;
        var _loop_1 = function () {
            var query = this_1._pending.shift();
            var message = query.message, peer = query.peer, response = query.response;
            var tid = this_1._tick++;
            if (tid >= 0xFFFF)
                this_1._tick = 0;
            message.t.writeUInt16BE(tid, 0);
            query.response = function (data, rinfo) {
                clearTimeout(query.timer);
                _this._running.delete(tid);
                response(data, rinfo);
                _this._runQueries();
            };
            query.timer = setTimeout(function () {
                query.response(null, null);
            }, 1000);
            this_1._running.set(tid, query);
            this_1._socket.send(bencode.encode(message), peer.port, peer.host);
        };
        var this_1 = this;
        while (this._pending.length && this._running.size < this.concurrency) {
            _loop_1();
        }
    };
    KRPC.prototype.query = function (peer, method, data) {
        var _this = this;
        var message = {
            t: new Buffer(2),
            y: 'q',
            q: method,
        };
        if (data)
            message.a = data;
        return new Promise(function (resolve, reject) {
            var response = function (data, rinfo) {
                if (data) {
                    if (data.nodes)
                        data.nodes = parseNodes(data.nodes);
                    if (data.values && method == 'get_peers')
                        data.values = decodePeers(data.values);
                }
                resolve(data);
            };
            _this._pending.push({ message: message, peer: peer, response: response });
            _this._runQueries();
        });
    };
    return KRPC;
}(events_1.EventEmitter));
exports.KRPC = KRPC;
var DHT = (function (_super) {
    __extends(DHT, _super);
    function DHT() {
        var _this = _super.call(this) || this;
        _this.id = crypto_1.randomBytes(20);
        _this.K = 20;
        _this._krpc = new KRPC();
        _this._tables = [];
        _this._krpc.on('query', function (query) {
            var peer = query.peer, method = query.method, data = query.data, response = query.response;
            var id = _this._closestID(data);
            switch (method) {
                case 'ping':
                    response({ id: id });
                    break;
                case 'find_node':
                    response({ id: id, nodes: '' });
                    break;
                case 'get_peers':
                    response({ id: id, nodes: '', token: 'TAOBKCEN' });
                    break;
                case 'announce_peer':
                    response({ id: id });
                    console.log(data);
                    break;
                default:
                    break;
            }
        });
        return _this;
    }
    DHT.prototype._closestID = function (node) {
        if (node.id) {
            var id = new Buffer(node.id);
            for (var i = id.length; i >= 0; --i) {
                if (id[i] != this.id[i]) {
                    id[i] = this.id[i];
                    break;
                }
            }
            return id;
        }
        return this.id;
    };
    DHT.prototype.lookup = function (target, table) {
        var _this = this;
        if (table === void 0) { table = new KBucket({ localNodeId: target }); }
        console.log('DHT.lookup');
        table.removeAllListeners('ping');
        table.on('ping', function (oldNodes, newNode) {
            oldNodes.forEach(function (node) { return table.remove(node.id); });
            table.add(newNode);
        });
        var closest = function () {
            return table.count() > DHT.BOOTSTRAP_NODES.length
                ? table.closest(target, _this.K)
                : DHT.BOOTSTRAP_NODES;
        };
        var queries = function () {
            return Promise.all(closest().map(function (peer) {
                return _this._krpc.query(peer, 'get_peers', { id: _this._closestID(peer), info_hash: target });
            }));
        };
        return new Promise(function (resolve) {
            var next = function () {
                queries().then(function (results) {
                    var peers = [];
                    results.filter(function (result) { return result; }).forEach(function (result) {
                        var nodes = result.nodes, values = result.values;
                        if (nodes)
                            nodes.forEach(function (node) { return table.add(node); });
                        if (values)
                            peers = peers.concat(values);
                    });
                    if (peers.length == 0) {
                        next();
                    }
                    else {
                        resolve(peers);
                    }
                });
            };
            next();
        });
    };
    DHT.prototype.metadata = function (target, peers) {
        var _this = this;
        if (peers === void 0) { peers = null; }
        console.log('DHT.metadata');
        var table = new KBucket({ localNodeId: target });
        var retries = 8;
        var fetch = function (peers) {
            var promises = peers.map(function (peer) {
                return new Promise(function (resolve) {
                    var socket = net.connect(peer.port, peer.host, function () {
                        var wire = new Protocol();
                        socket.pipe(wire).pipe(socket);
                        wire.use(ut_metadata());
                        wire.handshake(target, _this.id);
                        wire.ut_metadata.on('metadata', function (metadata) {
                            resolve(metadata);
                        });
                        wire.on('handshake', function () {
                            wire.ut_metadata.fetch();
                        });
                    });
                    setTimeout(function () {
                        socket.destroy();
                        resolve(null);
                    }, 5000);
                    socket.on('error', function (err) {
                        resolve(null);
                    });
                });
            });
            return Promise.all(promises).then(function (results) {
                return results.find(function (value) { return value != null; }) || null;
            });
        };
        return new Promise(function (resolve) {
            var next = function () {
                if (--retries < 0) {
                    resolve(null);
                }
                else {
                    Promise.resolve(peers || _this.lookup(target, table)).then(function (_peers) {
                        console.log(_peers.length);
                        peers = null;
                        fetch(_peers).then(function (metadata) {
                            if (metadata)
                                resolve(metadata);
                            else
                                next();
                        });
                    });
                }
            };
            next();
        });
    };
    DHT.prototype.crawle = function (concurrency) {
        var _this = this;
        if (concurrency === void 0) { concurrency = 200; }
        var running = 0, cache = [];
        var query = function (node) {
            if (node && cache.length < concurrency)
                cache.push(node);
            if (running < concurrency) {
                ++running;
                var node_1 = cache.shift(), id = _this._closestID(node_1);
                _this._krpc.query(node_1, 'find_node', { id: id, target: crypto_1.randomBytes(20) }).then(next);
            }
        };
        var next = function (data) {
            --running;
            if (data && data.nodes && data.nodes.length) {
                data.nodes.forEach(query);
            }
            else {
                query(null);
            }
        };
        DHT.BOOTSTRAP_NODES.forEach(query);
    };
    DHT.prototype.createRouter = function (target) {
        var _this = this;
        var table = new KBucket({ localNodeId: target }), method = 'find_node', args = { id: target, target: target };
        this._tables.push(table);
        var queries = function (peers) {
            return Promise.all(peers.map(function (peer) {
                return _this._krpc.query(peer, method, args);
            }));
        };
        return new Promise(function (resolve) {
            var next = function (results) {
                var count = table.count();
                results.filter(function (result) { return result; }).forEach(function (result) {
                    var nodes = result.nodes;
                    if (nodes)
                        nodes.forEach(function (node) { return table.add(node); });
                });
                if (count == 0 || table.count() - count > 0) {
                    queries(table.closest(target, 20)).then(next);
                }
                else {
                    resolve(table);
                }
            };
            queries(DHT.BOOTSTRAP_NODES).then(next);
        });
    };
    return DHT;
}(events_1.EventEmitter));
DHT.BOOTSTRAP_NODES = [
    { host: 'router.bittorrent.com', port: 6881 },
    { host: 'router.utorrent.com', port: 6881 },
    { host: 'dht.transmissionbt.com', port: 6881 }
];
exports.DHT = DHT;
function decodePeers(buf) {
    var peers = [];
    try {
        for (var i = 0; i < buf.length; i++) {
            var port = buf[i].readUInt16BE(4);
            if (!port)
                continue;
            peers.push({
                host: parseIp(buf[i], 0),
                port: port
            });
        }
    }
    catch (err) {
    }
    return peers;
}
function parseNodes(buf) {
    var contacts = [];
    try {
        for (var i = 0; i < buf.length; i += 26) {
            var port = buf.readUInt16BE(i + 24);
            if (!port)
                continue;
            contacts.push({
                id: buf.slice(i, i + 20),
                host: parseIp(buf, i + 20),
                port: port
            });
        }
    }
    catch (err) {
    }
    return contacts;
}
function parseIp(buf, offset) {
    return buf[offset++] + '.' + buf[offset++] + '.' + buf[offset++] + '.' + buf[offset++];
}

//# sourceMappingURL=data:application/json;base64,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Q0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUM7WUFDdEMsSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUE7WUFDbkMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQUMsUUFBUSxDQUFBO1lBQ25CLFFBQVEsQ0FBQyxJQUFJLENBQUM7Z0JBQ1YsRUFBRSxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUM7Z0JBQ3hCLElBQUksRUFBRSxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUM7Z0JBQzFCLElBQUksRUFBRSxJQUFJO2FBQ2IsQ0FBQyxDQUFBO1FBQ04sQ0FBQztJQUNMLENBQUU7SUFBQSxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBRWYsQ0FBQztJQUNELE1BQU0sQ0FBQyxRQUFRLENBQUE7QUFDbkIsQ0FBQztBQUVELGlCQUFpQixHQUFHLEVBQUUsTUFBTTtJQUN4QixNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUE7QUFDMUYsQ0FBQyIsImZpbGUiOiJrcnBjLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbmV0IGZyb20gJ25ldCc7XG5pbXBvcnQgKiBhcyBkZ3JhbSBmcm9tICdkZ3JhbSc7XG5pbXBvcnQgKiBhcyBiZW5jb2RlIGZyb20gJy4vYmVuY29kZSc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuaW1wb3J0ICogYXMgS0J1Y2tldCBmcm9tICdrLWJ1Y2tldCc7XG5pbXBvcnQgeyByYW5kb21CeXRlcyB9IGZyb20gJ2NyeXB0bydcblxuaW1wb3J0ICogYXMgUHJvdG9jb2wgZnJvbSAnYml0dG9ycmVudC1wcm90b2NvbCc7XG5pbXBvcnQgKiBhcyB1dF9tZXRhZGF0YSBmcm9tICd1dF9tZXRhZGF0YSc7XG5pbXBvcnQgKiBhcyBwYXJzZVRvcnJlbnQgZnJvbSAncGFyc2UtdG9ycmVudCc7XG5cbi8vOTAyODlmZDM0ZGZjMWNmOGYzMTZhMjY4YWRkODM1NGM4NTMzNDQ1OFxuXG5pbnRlcmZhY2UgTWVzc2FnZSB7XG4gICAgdDogQnVmZmVyLFxuICAgIHk6IFN0cmluZyxcbiAgICBxOiBTdHJpbmcsXG4gICAgYT86IGFueVxuICAgIGU/OiBhbnksXG4gICAgcj86IGFueVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBlZXIge1xuICAgIGhvc3Q6IHN0cmluZyxcbiAgICBwb3J0OiBudW1iZXJcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOb2RlIGV4dGVuZHMgUGVlciB7XG4gICAgaWQ6IEJ1ZmZlcixcbiAgICB0b2tlbj86IHN0cmluZ1xufVxuXG5leHBvcnQgY2xhc3MgS1JQQyBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gICAgY29uY3VycmVuY3kgPSAxMDA7XG5cbiAgICBfcnVubmluZyA9IG5ldyBNYXAoKTtcbiAgICBfcGVuZGluZyA9IG5ldyBBcnJheSgpO1xuICAgIFxuICAgIF90aWNrID0gMDtcblxuICAgIF9zb2NrZXQgPSBkZ3JhbS5jcmVhdGVTb2NrZXQoJ3VkcDQnKTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLl9zb2NrZXQub24oJ21lc3NhZ2UnLCAoZGF0YSwgcmluZm8pID0+IHtcbiAgICAgICAgICAgIGxldCBtZXNzYWdlOiBNZXNzYWdlID0gYmVuY29kZS5kZWNvZGUoZGF0YSksXG4gICAgICAgICAgICAgICAgdHlwZSA9IG1lc3NhZ2UueS50b1N0cmluZygpO1xuICAgICAgICAgICAgaWYgKHR5cGUgPT0gJ3InIHx8IHR5cGUgPT0gJ2UnKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHRpZCA9IG1lc3NhZ2UudC5yZWFkVUludDE2QkUoMCksXG4gICAgICAgICAgICAgICAgICAgICAgICBxdWVyeSA9IHRoaXMuX3J1bm5pbmcuZ2V0KHRpZCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChxdWVyeSkgcXVlcnkucmVzcG9uc2UobWVzc2FnZVt0eXBlXSwgcmluZm8pO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09ICdxJykge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCB0aWQgPSBtZXNzYWdlLnQucmVhZFVJbnQxNkJFKDApLFxuICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnkgOiBhbnkgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBtZXNzYWdlLnEudG9TdHJpbmcoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBtZXNzYWdlLmEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGVlcjoge2hvc3Q6IHJpbmZvLmFkZHJlc3MsIHBvcnQ6IHJpbmZvLnBvcnR9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlOiB0aGlzLl9yZXNwb25zZShtZXNzYWdlLCByaW5mbylcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdxdWVyeScsIHF1ZXJ5KTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX3Jlc3BvbnNlKG1lc3NhZ2UsIHJpbmZvKSB7XG4gICAgICAgIGxldCBfbWVzc2FnZSA9IG1lc3NhZ2U7XG4gICAgICAgIHJldHVybiBkYXRhID0+IHtcbiAgICAgICAgICAgIFByb21pc2UucmVzb2x2ZShkYXRhKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBtZXNzYWdlID0ge1xuICAgICAgICAgICAgICAgICAgICB0OiBfbWVzc2FnZS50LFxuICAgICAgICAgICAgICAgICAgICB5OiAncicsXG4gICAgICAgICAgICAgICAgICAgIHI6IGRhdGFcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5fc29ja2V0LnNlbmQoYmVuY29kZS5lbmNvZGUobWVzc2FnZSksIHJpbmZvLnBvcnQsIHJpbmZvLmFkZHJlc3MpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9ydW5RdWVyaWVzKCkge1xuICAgICAgICBcbiAgICAgICAgd2hpbGUodGhpcy5fcGVuZGluZy5sZW5ndGggJiYgIHRoaXMuX3J1bm5pbmcuc2l6ZSA8IHRoaXMuY29uY3VycmVuY3kpIHtcbiAgICAgICAgICAgIGxldCBxdWVyeSA9IHRoaXMuX3BlbmRpbmcuc2hpZnQoKTtcblxuICAgICAgICAgICAgbGV0IHttZXNzYWdlLCBwZWVyLCByZXNwb25zZX0gPSBxdWVyeTtcblxuICAgICAgICAgICAgbGV0IHRpZCA9IHRoaXMuX3RpY2sgKys7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICh0aWQgPj0gMHhGRkZGKSB0aGlzLl90aWNrID0gMDtcblxuICAgICAgICAgICAgbWVzc2FnZS50LndyaXRlVUludDE2QkUodGlkLCAwKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcXVlcnkucmVzcG9uc2UgPSAoZGF0YSwgcmluZm8pID0+IHtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQocXVlcnkudGltZXIpO1xuICAgICAgICAgICAgICAgIHRoaXMuX3J1bm5pbmcuZGVsZXRlKHRpZCk7XG4gICAgICAgICAgICAgICAgcmVzcG9uc2UoZGF0YSwgcmluZm8pO1xuICAgICAgICAgICAgICAgIHRoaXMuX3J1blF1ZXJpZXMoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcXVlcnkudGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICBxdWVyeS5yZXNwb25zZShudWxsLCBudWxsKTtcbiAgICAgICAgICAgIH0sIDEwMDApO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLl9ydW5uaW5nLnNldCh0aWQsIHF1ZXJ5KTtcbiAgICAgICAgICAgIHRoaXMuX3NvY2tldC5zZW5kKGJlbmNvZGUuZW5jb2RlKG1lc3NhZ2UpLCBwZWVyLnBvcnQsIHBlZXIuaG9zdCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBxdWVyeShwZWVyOiBQZWVyLCBtZXRob2QsIGRhdGE/OiBPYmplY3QpIHtcblxuICAgICAgICBsZXQgbWVzc2FnZTogTWVzc2FnZSA9IHtcbiAgICAgICAgICAgIHQ6IG5ldyBCdWZmZXIoMiksXG4gICAgICAgICAgICB5OiAncScsXG4gICAgICAgICAgICBxOiBtZXRob2QsXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGRhdGEpIG1lc3NhZ2UuYSA9IGRhdGE7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuICAgICAgICAgICAgbGV0IHJlc3BvbnNlID0gKGRhdGEsIHJpbmZvKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEubm9kZXMpXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLm5vZGVzID0gcGFyc2VOb2RlcyhkYXRhLm5vZGVzKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEudmFsdWVzICYmIG1ldGhvZCA9PSAnZ2V0X3BlZXJzJylcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEudmFsdWVzID0gZGVjb2RlUGVlcnMoZGF0YS52YWx1ZXMpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB0aGlzLl9wZW5kaW5nLnB1c2goe21lc3NhZ2U6IG1lc3NhZ2UsIHBlZXI6IHBlZXIsIHJlc3BvbnNlOiByZXNwb25zZX0pO1xuICAgICAgICAgICAgdGhpcy5fcnVuUXVlcmllcygpO1xuXG4gICAgICAgIH0pXG4gICAgfVxuXG59XG5cblxuZXhwb3J0IGNsYXNzIERIVCBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG5cbiAgICBpZCA9IHJhbmRvbUJ5dGVzKDIwKTtcbiAgICBLID0gMjA7XG5cbiAgICBzdGF0aWMgQk9PVFNUUkFQX05PREVTOiBBcnJheTxQZWVyPiA9IFtcbiAgICAgICAgeyBob3N0OiAncm91dGVyLmJpdHRvcnJlbnQuY29tJywgcG9ydDogNjg4MSB9LFxuICAgICAgICB7IGhvc3Q6ICdyb3V0ZXIudXRvcnJlbnQuY29tJywgcG9ydDogNjg4MSB9LFxuICAgICAgICB7IGhvc3Q6ICdkaHQudHJhbnNtaXNzaW9uYnQuY29tJywgcG9ydDogNjg4MSB9XG4gICAgXVxuXG4gICAgX2tycGMgPSBuZXcgS1JQQygpO1xuICAgIFxuICAgIF90YWJsZXMgPSBbXTtcbiAgICBcbiAgICBcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLl9rcnBjLm9uKCdxdWVyeScsIHF1ZXJ5ID0+IHtcbiAgICAgICAgICAgIGxldCB7cGVlciwgbWV0aG9kLCBkYXRhLCByZXNwb25zZX0gPSBxdWVyeTtcbiAgICAgICAgICAgIGxldCBpZCA9IHRoaXMuX2Nsb3Nlc3RJRChkYXRhKTtcblxuICAgICAgICAgICAgc3dpdGNoIChtZXRob2QpIHtcbiAgICAgICAgICAgICAgICBjYXNlICdwaW5nJzpcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UoeyBpZDogaWQgfSlcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSAnZmluZF9ub2RlJzpcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UoeyBpZDogaWQsIG5vZGVzOiAnJyB9KTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSAnZ2V0X3BlZXJzJzpcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UoeyBpZDogaWQsIG5vZGVzOiAnJywgdG9rZW46ICdUQU9CS0NFTicgfSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgJ2Fubm91bmNlX3BlZXInOlxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZSh7IGlkOiBpZCB9KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIF9jbG9zZXN0SUQobm9kZSkge1xuICAgICAgICBpZiAobm9kZS5pZCkge1xuICAgICAgICAgICAgbGV0IGlkID0gbmV3IEJ1ZmZlcihub2RlLmlkKTtcbiAgICAgICAgICAgIGZvcihsZXQgaSA9ICBpZC5sZW5ndGg7IGkgPj0gMDsgLS1pKSB7XG4gICAgICAgICAgICAgICAgaWYgKGlkW2ldICE9IHRoaXMuaWRbaV0pIHtcbiAgICAgICAgICAgICAgICAgICAgaWRbaV0gPSB0aGlzLmlkW2ldO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gaWQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuaWQ7XG4gICAgfVxuXG4gICAgbG9va3VwKHRhcmdldCwgdGFibGUgPSBuZXcgS0J1Y2tldCh7bG9jYWxOb2RlSWQ6IHRhcmdldH0pKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdESFQubG9va3VwJyk7XG4gICAgICAgIHRhYmxlLnJlbW92ZUFsbExpc3RlbmVycygncGluZycpO1xuICAgICAgICB0YWJsZS5vbigncGluZycsIChvbGROb2RlcywgbmV3Tm9kZSkgPT4ge1xuICAgICAgICAgICAgb2xkTm9kZXMuZm9yRWFjaChub2RlID0+IHRhYmxlLnJlbW92ZShub2RlLmlkKSk7XG4gICAgICAgICAgICB0YWJsZS5hZGQobmV3Tm9kZSk7XG4gICAgICAgIH0pXG4gICAgICAgIGNvbnN0IGNsb3Nlc3QgPSAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGFibGUuY291bnQoKSA+IERIVC5CT09UU1RSQVBfTk9ERVMubGVuZ3RoXG4gICAgICAgICAgICAgICAgPyB0YWJsZS5jbG9zZXN0KHRhcmdldCwgdGhpcy5LKVxuICAgICAgICAgICAgICAgIDogREhULkJPT1RTVFJBUF9OT0RFUztcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHF1ZXJpZXMgPSAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoY2xvc2VzdCgpLm1hcCgocGVlcikgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9rcnBjLnF1ZXJ5KHBlZXIsICdnZXRfcGVlcnMnLCB7aWQ6IHRoaXMuX2Nsb3Nlc3RJRChwZWVyKSwgaW5mb19oYXNoOiB0YXJnZXR9KTtcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbmV4dCA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICBxdWVyaWVzKCkudGhlbigocmVzdWx0czogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBwZWVycyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRzLmZpbHRlcihyZXN1bHQgPT4gcmVzdWx0KS5mb3JFYWNoKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQge25vZGVzLCB2YWx1ZXN9ID0gcmVzdWx0O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVzKSBub2Rlcy5mb3JFYWNoKG5vZGUgPT4gdGFibGUuYWRkKG5vZGUpKTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWVzKSBwZWVycyA9IHBlZXJzLmNvbmNhdCh2YWx1ZXMpO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICBpZiAocGVlcnMubGVuZ3RoID09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocGVlcnMpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgbWV0YWRhdGEodGFyZ2V0LCBwZWVycyA9IG51bGwpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ0RIVC5tZXRhZGF0YScpO1xuICAgICAgICBsZXQgdGFibGUgPSBuZXcgS0J1Y2tldCh7bG9jYWxOb2RlSWQ6IHRhcmdldH0pO1xuICAgICAgICBsZXQgcmV0cmllcyA9IDg7XG5cbiAgICAgICAgY29uc3QgZmV0Y2ggPSAocGVlcnMpID0+IHtcbiAgICAgICAgICAgIGxldCBwcm9taXNlcyA9IHBlZXJzLm1hcChwZWVyID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHNvY2tldCA9IG5ldC5jb25uZWN0KHBlZXIucG9ydCwgcGVlci5ob3N0LCAoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB3aXJlID0gbmV3IFByb3RvY29sKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzb2NrZXQucGlwZSh3aXJlKS5waXBlKHNvY2tldCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aXJlLnVzZSh1dF9tZXRhZGF0YSgpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgd2lyZS5oYW5kc2hha2UodGFyZ2V0LCB0aGlzLmlkKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgd2lyZS51dF9tZXRhZGF0YS5vbignbWV0YWRhdGEnLCAobWV0YWRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG1ldGFkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHdpcmUub24oJ2hhbmRzaGFrZScsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXJlLnV0X21ldGFkYXRhLmZldGNoKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgc29ja2V0LmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUobnVsbCk7XG4gICAgICAgICAgICAgICAgICAgIH0sIDUwMDApO1xuXG4gICAgICAgICAgICAgICAgICAgIHNvY2tldC5vbignZXJyb3InLCBlcnIgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShudWxsKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcykudGhlbihyZXN1bHRzID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0cy5maW5kKHZhbHVlID0+IHZhbHVlICE9IG51bGwpIHx8IG51bGw7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgbGV0IG5leHQgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKC0tIHJldHJpZXMgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUobnVsbCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgUHJvbWlzZS5yZXNvbHZlKHBlZXJzIHx8IHRoaXMubG9va3VwKHRhcmdldCwgdGFibGUpKS50aGVuKChfcGVlcnMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKF9wZWVycy5sZW5ndGgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcGVlcnMgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgZmV0Y2goX3BlZXJzKS50aGVuKChtZXRhZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZXRhZGF0YSkgcmVzb2x2ZShtZXRhZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBuZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5leHQoKTtcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBjcmF3bGUoY29uY3VycmVuY3kgPSAyMDApIHtcblxuICAgICAgICBsZXQgcnVubmluZyA9IDAsIGNhY2hlID0gW107XG5cbiAgICAgICAgY29uc3QgcXVlcnkgPSAobm9kZSkgPT4ge1xuICAgICAgICAgICAgaWYgKG5vZGUgJiYgY2FjaGUubGVuZ3RoIDwgY29uY3VycmVuY3kpIGNhY2hlLnB1c2gobm9kZSk7XG5cbiAgICAgICAgICAgIGlmIChydW5uaW5nIDwgY29uY3VycmVuY3kpIHtcbiAgICAgICAgICAgICAgICArKyBydW5uaW5nO1xuICAgICAgICAgICAgICAgIGxldCBub2RlID0gY2FjaGUuc2hpZnQoKSxcbiAgICAgICAgICAgICAgICAgICAgaWQgPSB0aGlzLl9jbG9zZXN0SUQobm9kZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5fa3JwYy5xdWVyeShub2RlLCAnZmluZF9ub2RlJywge2lkOiBpZCwgdGFyZ2V0OiByYW5kb21CeXRlcygyMCl9KS50aGVuKG5leHQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBuZXh0ID0gKGRhdGEpID0+IHtcbiAgICAgICAgICAgIC0tIHJ1bm5pbmc7XG5cbiAgICAgICAgICAgIGlmIChkYXRhICYmIGRhdGEubm9kZXMgJiYgZGF0YS5ub2Rlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBkYXRhLm5vZGVzLmZvckVhY2gocXVlcnkpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHF1ZXJ5KG51bGwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgICAgICBESFQuQk9PVFNUUkFQX05PREVTLmZvckVhY2gocXVlcnkpXG5cbiAgICB9XG5cbiAgICBjcmVhdGVSb3V0ZXIodGFyZ2V0KSB7XG4gICAgICAgIGxldCB0YWJsZSA9IG5ldyBLQnVja2V0KHtsb2NhbE5vZGVJZDogdGFyZ2V0fSksXG4gICAgICAgICAgICBtZXRob2QgPSAnZmluZF9ub2RlJyxcbiAgICAgICAgICAgIGFyZ3MgPSB7aWQ6IHRhcmdldCwgdGFyZ2V0OiB0YXJnZXR9O1xuICAgICAgICBcbiAgICAgICAgdGhpcy5fdGFibGVzLnB1c2godGFibGUpO1xuXG4gICAgICAgIGNvbnN0IHF1ZXJpZXMgPSAocGVlcnMpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChwZWVycy5tYXAoKHBlZXIpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fa3JwYy5xdWVyeShwZWVyLCBtZXRob2QsIGFyZ3MpO1xuICAgICAgICAgICAgfSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBuZXh0ID0gKHJlc3VsdHM6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBjb3VudCA9IHRhYmxlLmNvdW50KCk7XG4gICAgICAgICAgICAgICAgcmVzdWx0cy5maWx0ZXIocmVzdWx0ID0+IHJlc3VsdCkuZm9yRWFjaChyZXN1bHQgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQge25vZGVzfSA9IHJlc3VsdDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVzKSBub2Rlcy5mb3JFYWNoKG5vZGUgPT4gdGFibGUuYWRkKG5vZGUpKTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgICAgIGlmIChjb3VudCA9PSAwIHx8IHRhYmxlLmNvdW50KCkgLSBjb3VudCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcmllcyh0YWJsZS5jbG9zZXN0KHRhcmdldCwgMjApKS50aGVuKG5leHQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUodGFibGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBxdWVyaWVzKERIVC5CT09UU1RSQVBfTk9ERVMpLnRoZW4obmV4dCk7XG4gICAgICAgIH0pXG4gICAgfVxuXG59XG5cbmZ1bmN0aW9uIGRlY29kZVBlZXJzIChidWYpIHtcbiAgdmFyIHBlZXJzID0gW11cblxuICB0cnkge1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYnVmLmxlbmd0aDsgaSsrKSB7XG4gICAgICB2YXIgcG9ydCA9IGJ1ZltpXS5yZWFkVUludDE2QkUoNClcbiAgICAgIGlmICghcG9ydCkgY29udGludWVcbiAgICAgIHBlZXJzLnB1c2goe1xuICAgICAgICBob3N0OiBwYXJzZUlwKGJ1ZltpXSwgMCksXG4gICAgICAgIHBvcnQ6IHBvcnRcbiAgICAgIH0pXG4gICAgfVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyBkbyBub3RoaW5nXG4gIH1cblxuICByZXR1cm4gcGVlcnNcbn1cblxuZnVuY3Rpb24gcGFyc2VOb2RlcyhidWYpIHtcbiAgICB2YXIgY29udGFjdHMgPSBbXVxuXG4gICAgdHJ5IHtcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBidWYubGVuZ3RoOyBpICs9IDI2KSB7XG4gICAgICAgICAgICB2YXIgcG9ydCA9IGJ1Zi5yZWFkVUludDE2QkUoaSArIDI0KVxuICAgICAgICAgICAgaWYgKCFwb3J0KSBjb250aW51ZVxuICAgICAgICAgICAgY29udGFjdHMucHVzaCh7XG4gICAgICAgICAgICAgICAgaWQ6IGJ1Zi5zbGljZShpLCBpICsgMjApLFxuICAgICAgICAgICAgICAgIGhvc3Q6IHBhcnNlSXAoYnVmLCBpICsgMjApLFxuICAgICAgICAgICAgICAgIHBvcnQ6IHBvcnRcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgXG4gICAgfVxuICAgIHJldHVybiBjb250YWN0c1xufVxuXG5mdW5jdGlvbiBwYXJzZUlwKGJ1Ziwgb2Zmc2V0KSB7XG4gICAgcmV0dXJuIGJ1ZltvZmZzZXQrK10gKyAnLicgKyBidWZbb2Zmc2V0KytdICsgJy4nICsgYnVmW29mZnNldCsrXSArICcuJyArIGJ1ZltvZmZzZXQrK11cbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
